<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
	</head>
	<body>
		<div id="iframe-parent" style="opacity: 0; position: absolute; z-index: -1;"></div>
		<h3>Paraphrase:-</h3>
		<textarea id='textarea' rows="12" cols="80%"></textarea>
		<h3>Result:-</h3>
		<textarea id='result' rows="12" cols="80%"></textarea>
		<button onclick="paraphrase()" id="button">Go</button>
		<script>
			const languages = ['ms', 'sn', 'mi', 'ro', 'ny', 'de', 'pl', 'fi', 'is', 'la', 'jw', 'ht', 'fr', 'eo', 'eu'];
			let languagesOTG;
			
			window.addEventListener("message", (e) => {
				if (typeof e.data !== 'object') return;
				if (e.data.type === 'ready') {
					
				} else if (e.data.type === 'success') {
					successFrame(e.data.result);
				}
				console.log(e.data);
			}, false);
			
			function successFrame(result) {
				document.getElementById('result').value = result;
				document.getElementById('button').disabled = false;
			}
			
			let elem = document.getElementById('iframe-parent'),
			    result = document.getElementById('result');

			function prepareFrame(src, parentElement) {
				let ifrm = document.createElement("iframe");
				ifrm.setAttribute("src", src);
				ifrm.style.width = "200px";
				ifrm.style.height = "200px";
				parentElement.appendChild(ifrm);
				return ifrm;
			}
			
			function destroyFrame(iframe) {
				return iframe.parentElement.removeChild(iframe);
			}

			function shuffleArray(array) {
				let newArr = array.slice();
				for (let i = newArr.length - 1; i > 0; i--) {
					const rand = Math.floor(Math.random() * (i + 1));
					[newArr[i], newArr[rand]] = [newArr[rand], newArr[i]];
				}
				return newArr;
			}

			function paraphrase() {
				if (document.getElementById('textarea').value.split(" ").length < 15) {
					alert("Must contains at least 15 words yo!");
					return;
				} else if (document.getElementById('textarea').value.split(" ").length >= 400) {
					alert("Too many words yo!");
					return;
				}
				
				document.getElementById('button').disabled = true;
				
				// Clone and shuffle array
				languagesOTG = shuffleArray(languages).slice((((Math.random() * 3) + 2) << 0) * -1);
				// Insert 'en' language at first and last index
				languagesOTG.unshift('en');
				languagesOTG.push('en');
				
				// Start translation
				initTranslation().then(e => {
					e[0].contentWindow.postMessage({
						'languages': languagesOTG,
						'sourceText': document.getElementById('textarea').value
					}, '*');
				}).catch(console.log);
			}

			function initTranslation() {
				// Create iframe
				let ifrm = prepareFrame('google-translate-embed-v2.html', document.getElementById('iframe-parent'));
				
				const promise1 = new Promise((resolve, reject) => {
					// Iframe onLoad handler
					function onLoad() {
						ifrm.removeEventListener('load', onLoad) || resolve(ifrm);
					}
					setTimeout(() => {
						ifrm.removeEventListener("load", onLoad) || reject(new Error('Iframe load status timeout!'));
					}, 5000);
					ifrm.addEventListener('load', onLoad);
				});
				
				const promise2 = new Promise((resolve, reject) => {
					// Embed onReady handler
					function onMessage(e) {
						if (typeof e.data !== 'object') reject(new Error("Invalid message received!"));
						if (e.data.type === 'ready') {
							window.removeEventListener("message", onMessage) || resolve();
						}
						console.log(e.data);
					}
					setTimeout(() => {
						window.removeEventListener("message", onMessage) || reject(new Error('Embed ready status timeout!'));
					}, 5000);
					window.addEventListener("message", onMessage);
				});
				
				return Promise.all([promise1, promise2]);
			}
		</script>
	</body>
</html>
