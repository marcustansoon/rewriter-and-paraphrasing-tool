<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
	</head>
	<body>
		<div id="source">Criminology is the study of crime and criminal behavior, informed by principles of sociology and other non-legal fields, including psychology, economics, statistics, and anthropology. Criminologists examine a variety of related areas, including: Characteristics of people who commit crimes.</div>
		<div id="google_translate_element"></div>
		<script type="text/javascript">
			let isGoogleTranslateReady;
			
			window.onmessage = function(e) {
				try {
					if (!e || !e.data) throw 'Invalid message received!';
				} catch (e) {
					alert(e);
					return;
				}
				if (typeof e.data === 'object' && e.data.sourceLanguage && e.data.targetLanguage && e.data.sourceText) {
					// Set source text
					document.getElementById('source').innerHTML = e.data.sourceText;
					
					// Check for completion
					setTimeout(()=>
						   checkTranslationCompletion({
							'sourceText' : e.data.sourceText, 
							'sourceElement' : document.getElementById('source'),
							'errCallback' : function() {
								window.top.postMessage(JSON.stringify({'type': 'failed'}), '*')
						   	}, 
							'callback' : function() {
								window.top.postMessage(JSON.stringify({'type': 'success', 'result': document.getElementById('source').innerHTML}), '*')
							}
						})
					, 500);
				
					// Run Google Translate
					googleTranslateElementRun(e.data.sourceLanguage, e.data.targetLanguage);
				}
			};
			
			
			function checkTranslationCompletion(obj){
				// Set counter value during first run
				if(!obj.hasOwnProperty("counter")) obj.counter = 0;
				
				// Increment counter
				obj.counter++;
				
				// Check for completion
				if(obj.sourceText !== obj.sourceElement.innerHTML) {
					obj.hasOwnProperty('callback') && obj.callback();
					return;
				}
				
				// Check for timeout translation
				if(obj.counter > 10){
					obj.hasOwnProperty('errCallback') && obj.errCallback();
					return;
				}
				
				// Run next check
				setTimeout(() => checkTranslationCompletion(obj), 500);
			}

			function googleTranslateReady() {
				isGoogleTranslateReady = true;
			}

			function googleTranslateElementRun(sourceLanguage, targetLanguage) {
				if (!isGoogleTranslateReady) return;
				new google.translate.TranslateElement({
					'pageLanguage': sourceLanguage,	// Set source language
				}, 'google_translate_element');
				
				// Get Google Translate input selector
				let elem = document.querySelector('#google_translate_element select');
				if(!elem) return;
				
				// Set target language
				elem.value = targetLanguage;
				
				// Trigger translation
				elem.dispatchEvent(new Event('change'));
			}
		</script>
		<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateReady"></script>
	</body>
</html>
