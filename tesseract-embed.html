<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
	</head>
	<body>
		<script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
		<script type="modules">
			import Tesseract from 'tesseract.js';
		</script>
		<script type="text/javascript">
			
			window.onmessage = function(e) {
				try {
					if (!e || !e.data) throw 'Invalid message received!';
				} catch (e) {
					alert(e);
					return;
				}
				//console.log('Received');
				//console.log(e.data);
				if (typeof e.data === 'object' && e.data.base64Image) {
					// Run
					runTesseract(e.data.base64Image).then(text => {
						window.top.postMessage({
							'type': 'success',
							'text': text,
						}, '*');
					}).catch(e => {
						window.top.postMessage({
							'type': 'error',
							'text': e,
						}, '*');
					});
				}
			};
			
			(function tesseractReadyCheck() {
				const interval = setInterval(() => {
					if(typeof Tesseract === 'undefined') return;
					clearInterval(interval);
					window.top.postMessage({
						'type': 'ready'
					}, '*');
					console.log('t ready');
				}, 500);
			})();
			
			function runTesseract (base64Image) {
				const promise = new Promise(async (resolve, reject) => {
					try {
						const blob = await fetch(base64Image).then(res => res.blob());
						const url = URL.createObjectURL(blob, {
							type: "image/png"
						});
						const { data: { text } } = await Tesseract.recognize(url, 'eng', {logger: m => console.log(m)});
						resolve(text);
					} catch (e) {
						reject(new Error(e));
					}
				});
			}
		</script>
	</body>
</html>
